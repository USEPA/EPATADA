---
title: "TADA Module 3: Associating WQP Characteristics with Applicable ATTAINS Parameters and Uses"
format: html
editor: visual
author: "TADA Team"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    fig_caption: yes
    fig_height: 8
    fig_width: 8
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{TADA Module 3: Associating WQP Characteristics with Applicable ATTAINS Parameters and Uses}
  %\VignetteEngine{knitr::rmarkdown}
description: The first of multiple vignettes (under development) showcasing TADA Module 3 functions and a recommended workflow.
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, include = F}
library(knitr)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```

## Welcome!

Thank you for your interest in Tools for Automated Data Analysis (TADA).
TADA is an open-source tool set built in the R programming language.
This [RMarkdown](https://bookdown.org/yihui/rmarkdown/) document walks
users through how to download the EPATADA R package from GitHub, access
and parameterize several important functions, and create basic
visualizations with a sample data set.

**Note: EPATADA is still under development. New functionality is added
weekly, and sometimes we need to make bug fixes in response to tester
and user feedback. We appreciate your feedback, patience, and interest
in these helpful tools.**

**If you are interested in contributing to EPATADA development, more
information is available at:**

[**Contributing**](https://usepa.github.io/EPATADA/articles/CONTRIBUTING.html)

**We welcome collaboration with external partners.**

## Install and load packages

First, install and load the remotes package specifying the repo. This is
needed before installing EPATADA because it is only available on GitHub.

```{r install_remotes, results = 'hide', eval = F}
install.packages("remotes",
  repos = "http://cran.us.r-project.org"
)
library(remotes)
```

Next, install and load the EPATADA R Package using the remotes package.
Dependency packages will also be downloaded automatically from CRAN. You
may be prompted in the console to update dependencies that have more
recent versions available. If you see this prompt, it is recommended to
update all of them (enter 1 into the console).

```{r install_TADA_dev, eval = T, include = F}
# helps with development (knit and checks), this chunk should not appear on website
remotes::install_github("USEPA/EPATADA",
  ref = "Create-Module-3-AURef",
  dependencies = TRUE
)
```

```{r install_TADA, eval = F, results = 'hide'}
remotes::install_github("USEPA/EPATADA",
  ref = "develop",
  dependencies = TRUE
)
```

Finally, use the **library()** function to load the EPATADA R Package
into your R session.

```{r library, results = 'hide'}
library(EPATADA)
```

## Help pages

All TADA R package functions have their own individual help pages,
listed on the [Function
reference](https://usepa.github.io/EPATADA/reference/index.html) page on
the GitHub site. Users can also access the help page for a given
function in R or RStudio using the following format (example below):
`?[name of TADA function]`

```{r help_pages, eval = F}
# Access help page for TADA_DataRetrieval
?TADA_DataRetrieval
```

## Module 3 Functions in TADA

Disclaimer: The EPATADA Module 3 functions were designed to: (1) assist
users with associating Water Quality Portal monitoring locations with
assessment units and designated uses from ATTAINS and (2) compare Water
Quality Portal results with numeric water quality criteria. EPATADA
functions do not constitute current EPA policy or regulatory
requirements. Organizations may choose to use EPATADA as a a tool in
their decision making processes. Use of EPATADA is not required.

## Introduction

Criteria are defined as the Magnitude, duration and frequency associated
with a parameter and designated use.

-   Magnitude is defined as the limiting concentration not to be
    exceeded.

-   Duration is the period/length of time in which observations are
    aggregated.

-   Frequency is defined as the percent or number of times in which a
    magnitude can be exceeded during the specified duration.

This vignette provides an overview of functions that assist users with:

-   Matching WQP monitoring locations to ATTAINS assessment units by
    leveraging ATTAINS web services.

-   Creating a parameter crosswalk between ATTAINS parameter names and
    WQP/TADA parameter names.

-   Defining the designated uses of each ATTAINS assessment unit
    represented in the user's TADA data set.

-   Assigning the parameters which correspond with each unique
    assessment unit/designated use/parameter combination.

-   Defining the numeric water quality criteria and methodology used for
    each unique combination of assessment unit, designated use, and
    parameter.

-   Summarizing results by either: (1) individual magnitude excursions
    or (2) full Criteria (Magnitude, Duration and Frequency) associated
    with each parameter and use.

Module 3 functions are designed with the flexibility for users from
states, tribes, or territories to input organization-specific or
site-specific criteria as defined in their own numeric water quality
critieria or methdogologies. While TADA functions automate some of this
process, users must review and modify the crosswalk tables generated in
each step of the process to ensure their accuracy. The TADA team has
also incorporated national recommended Clean Water Act (CWA) 304(a)
numeric criteria for optional use in Module 3 functions by leveraging
data from the Criteria Search Tool (CST). This allows users to test the
new functions using 304(a) criteria and allows users to easily compare
results when comparing WQP results to 304(a) criteria vs. their own
organization's criteria.

**Additional Description:**

This vignette is the first of several series in Module 3. This vignette
will focus on assisting users to create the crosswalk reference tables
that are needed prior to defining and capturing your organization's
criteria and methodologies. We will start the example by going through
an example data frame that has gone through data cleaning, wrangling,
harmonization, handling of censored data and other Module 1 TADA
functions.

## Example with Data_WV_Mod1_Output

Using an example data set from Maryland, we will work through an example
of creating the three TADA Module 3 reference tables that facilitate the
association of WQP monitoring locations with assessment units/designated
uses and the comparison of WQP results with the numeric criteria
associated with the relevant assessment unit/designated use. This
example represents the recommended workflow for Module 3.

The necessary data cleaning, harmonization, removal of suspect results,
and other QAQC processes must be completed by users before utilizing
Module 3 functions. The example TADA data frame used in this vignette
has already been through this process. See Module 1 Workflow.R script to
review how this example data frame was prepared.

```{r}
# import example data set (output of Module 1 Workflow)
Data_NCTC <- Data_WV_Mod1_Output
```

## TADA_CreateParamRef() Basics

Before, creating the parameter reference table, we will perform some
exploratory data analysis to understand the components involve in
TADA_CreateParamRef. First, let's view the number of counts of
TADA.ComparableDataIdentifier.

```{r}
# create table with counts of TADA.ComparableDataIdentifiers
TADA_FieldValuesTable(Data_NCTC, field = "TADA.ComparableDataIdentifier")
```

We can also review the domain values of parameter names listed as causes
in prior assessment cycles (for all organizations) in ATTAINS by using a
function from rATTAINS, which provides functions for downloading tidy
data from the ATTAINS public web services
(<https://github.com/mps9506/rATTAINS>).

```{r, eval = FALSE}
TADA_CSVExport(rATTAINS::domain_values(domain_name = "ParameterName"))
```

As the ATTAINS parameters are more general than the
TADA.ComparableDataIdenitfiers, it is not possible at this time to
completely automate the assignment of TADA.ComparableIentifiers to
ATTAINS parameters. TADA_CreateParamRef() creates a template which
includes all TADA.ComparableDataIdentifiers from the TADA data frame and
provides a blank column, "ATTAINS.ParameterName" for users to input the
corresponding ATTAINS parameter name. The function automatically pairs
the EPA 304(a) pollutant name with the TADA.ComparableDataIdentifier for
some priority characteristics.

Setting "excel = TRUE" in TADA_CreateParamRef causes the function to
automatically create an Excel spreadsheet of the reference table for
easy review and editing. If users do not want to work in Excel, they can
use "excel = FALSE" to return a data frame. The data frame can be edited
directly in R if desired, although there are no TADA-specific functions
designed to facilitate this.

When using TADA_CreateParamRef(), users should specify the
organization(s) of interested in the "org_names" argument. This ensures
that the correct number of rows will be created in the reference table.
When "excel = TRUE", specifying the organization(s) also creates a
separate tab in the Excel file which contains the parameter names used
in prior assessment cycles by the specified ATTAINS organization(s).
This will allow users to decide whether to continue to use the same
ATTAINS parameter names from prior assessments that their
organizations(s) have used in the past, or to use other valid parameter
names from the entire ATTAINS domain list. If there is not a suitable
ATTAINS parameter name to match a TADA.ComparableDataIdentifier, users
should contact the ATTAINS team (attains\@epa.gov) for assistance.

```{r}
# create parameter reference table
NCTC_ParamRef <- TADA_CreateParamRef(
  Data_NCTC,
  org_id = c("MDE_EASP"),
  excel = FALSE, # change to TRUE to download excel file
  overwrite = FALSE
)
# export parameter refrence table as csv
EPATADA::TADA_CSVExport(ref = NCTC_ParamRef)
```

Once the parameter reference table has been reviewed and modified, it
can be saved and reused for analysis of future TADA data frames.

The code chunk below demonstrates how the paramter rerefence table can
be modififed in R. Once modifcations are complete, we can re-run
TADA_CreateParamRef using the modified parameter reference table as the
input for "paramRef". This will update the ATTAINS.FlagParameterName
column in the parameter reference table (see NCTC_ParamRef2 in example
below). This column provides information about whether or not the
organization specified in the "organization_identifier" column has
listed this parameter as a cause in prior assessment cycles. It also
flags rows where the TADA.ComparableDataIdentifier as not been assigned
an ATTAINS parameter name.

```{r}
# only run the code chunks below if you make edits to the excel file.
# downloads_path <- file.path(Sys.getenv("USERPROFILE"), "Downloads", "myfileRef.xlsx")
# ParamRef <- openxlsx::read.xlsx(downloads_path, sheet = "CreateParamRef")

# NCTC_ParamRef3 <- TADA_CreateParamRef(
#   Data_NCTC,
#   org_names = c("MDE_EASP"),
#   paramRef = ParamRef,
#   excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
#   #excel = TRUE, overwrite = TRUE
#   )

ParamRef <- dplyr::mutate(NCTC_ParamRef, ATTAINS.ParameterName = dplyr::case_when(
  TADA.CharacteristicName == "PH" ~ "PH",
  TADA.ComparableDataIdentifier == "ZINC_TOTAL_NA_UG/L" ~ "ZINC",
  grepl("NITRATE", TADA.ComparableDataIdentifier) ~ "NITROGEN, TOTAL"
))
TADA_CSVExport(ref = ParamRef)

NCTC_ParamRef2 <- TADA_CreateParamRef(
  Data_NCTC,
  org_id = c("MDE_EASP"),
  paramRef = ParamRef,
  excel = FALSE
) # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
# excel = TRUE, overwrite = TRUE)
TADA_CSVExport(ref = NCTC_ParamRef2)
```

# Three cases of TADA_CreateParamUseRef().

First example will pull in all prior use_names for each ATTAINS
parameter name specific to the defined org_names argument input
"Maryland". Users will review this list and choose which use_name are
appropriate to define for assessment. The default is "Include" under the
"IncludeOrExclude" column. All use_names that will need a definition for
magnitude criteria and methodology should be labeled as "Include". If a
use_name is not appropriate, users should choose "Exclude" for that
ATTAINS parameter name and use name.

For any ATTAINS parameter name(s) that have not been used by this org in
prior assessment cycles, there will be no prior use names associated
with them. In this case, users will be responsible for inputting
additional rows as needed and choosing the appropriate use_name
applicable to their org under the column 'use_name'.

For example, we can see "PH" was not a prior ATTAINS parameter name for
MDE_EASP, thus additional rows should be inputted to reflect what
parameter and use combinations are needed to be defined for assessments
(disclaimer: this is for demonstration purposes only and does not
reflect MDE_EASP's Criteria and Methodologies for PH).

```{r}
NCTC_ParamUseRef <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_id = c("MDE_EASP"),
  paramRef = ParamRef,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
TADA_CSVExport(ref = NCTC_ParamUseRef)
```

User can include the EPA304a standards with the input "org_names", which
utilizes the EPA304a.PollutantName column created in
TADA_CreateParamRef(). If a user includes additional orgs besides
"MDE_EASP" and "EPA304a", see example NCTC_ParamUseRef2 below, it will
not generate rows for those parameter and use combinations for those
additional orgs ("21VASWCB" (Virginia), "21PA"(Pennsylvania), WVDEP
(West Virginia)) as only MDE_EASP (Maryland) was defined in
TADA_CreateParamRef() for paramRef = ParamRef.

```{r}
NCTC_ParamUseRef2 <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_id = c("EPA304a", "MDE_EASP", "21VASWCB", "21PA", "WVDEP"),
  paramRef = ParamRef,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
TADA_CSVExport(ref = NCTC_ParamUseRef2)

# User should only run TADA_CreateParamUseRef() which contains the orgs of interest. If there are other orgs that are interested, this should have been defined in TADA_CreateParamRef() for the paramRef argument input in which users will need to be aware of the appropriate parameter name crosswalk (if users share their criteria and methods in the future, this could be more feasible)
NCTC_ParamUseRef3 <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_id = c("EPA304a", "MDE_EASP"),
  paramRef = NCTC_ParamRef2,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
TADA_CSVExport(ref = NCTC_ParamUseRef3)
```

In this example, **Maryland** has decided to use an
ATTAINS.ParameterName "PH" as a crosswalk for
TADA.ComparableDataIdentifier 'PH_NA_NA_STD UNITS' which was not used in
prior ATTAINS assessment cycle for **Maryland**. This results in the
'use_name' column returning a blank value for ATTAINS.ParameterName
"PH". MDE_EASP will need to specify the use_name(s) that they would like
to associate with "PH". In excel, there will be a drop down list of org
specific use_names that were used in prior ATTAINS assessments. If no
excel file was generated, this is an example workflow of what a user can
do to edit the table in the R environment.

```{r paged.print=TRUE}
add_data <- data.frame("organization_identifier" = "MDE_EASP", "ATTAINS.ParameterName" = rep("PH", 3), "use_name" = c(
  "Aquatic Life and Wildlife", "Water Contact Sports",
  "Seasonal Migratory Fish Spawning and Nursery Subcategory"
))

# The output of this will not reflect changes to the ATTAINS.FlagUseName column. To do so, we need to re run TADA_CreateParamUseRef() with paramUseRef = ParamUseRef as an argument.
ParamUseRef <- NCTC_ParamUseRef3 %>%
  dplyr::left_join(add_data, by = c("organization_identifier", "ATTAINS.ParameterName"), keep = FALSE) %>%
  dplyr::mutate(use_name = dplyr::coalesce(use_name.x, use_name.y)) %>%
  dplyr::select(-c(use_name.x, use_name.y))

# User now has a saved dataframe which can be used to reflect any updates of Parameter-use ref in the future.
TADA_CSVExport(ref = ParamUseRef)

# PH will now reflect the changes
NCTC_ParamUseRef3.1 <- TADA_CreateParamUseRef(
  Data_NCTC,
  paramUseRef = ParamUseRef, # Edits were made to paramUseRef, updates flag column
  org_id = c("EPA304a", "MDE_EASP"),
  paramRef = NCTC_ParamRef2,
  excel = FALSE # comment out 'excel = FALSE' and uncomment 'excel = TRUE, overwrite = TRUE' to run the excel file
  # excel = TRUE, overwrite = TRUE
)
TADA_CSVExport(ref = NCTC_ParamUseRef3.1)
```

Users must review the matching done with TADA_GetATTAINS of monitoring
sites to AU. Users may also provide their own AU monitoring sites match
as a reference table. For any new WQP monitoring sites found in the TADA
dataframe, users will need to determine the appropriate match. Users can
also choose to not provide any sort of ML to AU crosswalk if they are
only interested in a monitoring location site level analysis of
assessments.

If there are site-specific criteria that only applies to some monitoring
locations within an AU, whether it's an ecoregion, for a specific
parameter and use, or if there are separate criteria for "warm-waters"
versus "cold-waters" or "trout-based" versus other species based, this
should be defined here. Users can further customize specific exclusions
that pertains to their water quality assessments. Users will be
responsible for filling out this unique spatial criteria under
"ApplyUniqueSpatialCriteria" column.

In this example below, no ML to AU crosswalk was provided.

```{r}
# NCTC_AURef <- TADA_CreateAURef(Data_NCTC, excel = FALSE)
# tidyr::as_tibble(NCTC_AURef)
# NCTC_AURef <- TADA_CreateAURef(Data_NCTC, excel = TRUE, overwrite = TRUE)
```

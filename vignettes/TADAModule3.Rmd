---
title: "TADA Module 3: Integration of Common Water Quality Standards (WQS) Criteria"
format: html
editor: visual
author: "TADA Team"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    fig_caption: yes
    fig_height: 8
    fig_width: 8
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{TADA Module 3: Integration of Common Water Quality Standards (WQS) Criteria}
  %\VignetteEngine{knitr::rmarkdown}
description: An overview of TADA Module 3 functions and a recommended workflow.
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, include = F}
library(knitr)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```

## Welcome!

Thank you for your interest in Tools for Automated Data Analysis (TADA).
TADA is an open-source tool set built in the R programming language.
This [RMarkdown](https://bookdown.org/yihui/rmarkdown/) document walks
users through how to download the EPATADA R package from GitHub, access
and parameterize several important functions, and create basic
visualizations with a sample data set.

**Note: EPATADA is still under development. New functionality is added
weekly, and sometimes we need to make bug fixes in response to tester
and user feedback. We appreciate your feedback, patience, and interest
in these helpful tools.**

**If you are interested in contributing to EPATADA development, more
information is available at:**

[**Contributing**](https://usepa.github.io/EPATADA/articles/CONTRIBUTING.html)

**We welcome collaboration with external partners.**

## Install and load packages

First, install and load the remotes package specifying the repo. This is
needed before installing EPATADA because it is only available on GitHub.

```{r install_remotes, results = 'hide', eval = F}
install.packages("remotes",
  repos = "http://cran.us.r-project.org"
)
library(remotes)
```

Next, install and load the EPATADA R Package using the remotes package.
Dependency packages will also be downloaded automatically from CRAN. You
may be prompted in the console to update dependencies that have more
recent versions available. If you see this prompt, it is recommended to
update all of them (enter 1 into the console).

```{r install_TADA_dev, eval = T, include = F}
# help with knit and pass the checks, but we want to make sure this chunk does not show up in the final website, just for development.
remotes::install_github("USEPA/EPATADA",
  ref = "Create-Module-3-Reference-Tables",
  dependencies = TRUE
)
```

```{r install_TADA, eval = F, results = 'hide'}
remotes::install_github("USEPA/EPATADA",
  ref = "develop",
  dependencies = TRUE
)
```

Finally, use the **library()** function to load the EPATADA R Package
into your R session.

```{r library, results = 'hide'}
library(EPATADA)
```

## Help pages

All TADA R package functions have their own individual help pages,
listed on the [Function
reference](https://usepa.github.io/EPATADA/reference/index.html) page on
the GitHub site. Users can also access the help page for a given
function in R or RStudio using the following format (example below):
`?[name of TADA function]`

```{r help_pages, eval = F}
# Access help page for TADA_DataRetrieval
?TADA_DataRetrieval
```

## WQS Criteria Functions in TADA

Disclaimer: Use of Module 3 development and tools in the EPATADA package
is to assist different organization (state, territories and tribal
nations) on their assessment methods under the CWA. It does not
constitute current Agency policy or regulation requirements. This tool
is not to be solely used for decision making process. Module 3
integration of WQS for assessments is not a regulation and does not
impose legally binding requirements on EPA or the States in reporting
water conditions under biannual reports of the CWA.

Criteria is defined as the Magnitude, duration and frequency associated
with a parameter and designated use.

-   Magnitude is defined as the limiting concentration not to be
    exceeded.

-   Duration is the period/length of time in which observations are
    aggregated.

-   Frequency is defined as the percent or number of times in which a
    magnitude can be exceeded during a time frame.

This vignette represents functions that require users to:

-   Perform a parameter crosswalk between ATTAINS parameter names and
    WQP/TADA parameter names, define the parameter and designated use of
    a water body associated with each state and participating tribe's
    WQS criteria, and define the geospatial components to match WQP
    monitoring sites to an Assessment Unit.

-   Define the Criteria and Methodologies used for assessments and
    determine recommended impairment decisions for each parameter and
    designated use of a water body based on these defined WQS criteria
    conditions for each AU. Users will have two options of either
    summarizing individual magnitude excursions or for the full Criteria
    (Magnitude, Duration and Frequency) associated with each parameter
    and use.

The EPA has derived its "national recommended Clean Water Act (CWA)
304(a) criteria". Using data from the Criteria Search Tool (CST), the
TADA team has developed initial efforts to incorporate these metrics as
the standards that can be used to determine magnitude excursions and
full criteria exceedance for a parameter and use.

However, the EPA304a standards do not account for more each
state-specific or site-specific conditions in which each state may
derive its own criteria. The functions in Module 3 TADA aims to be
flexible to capture these criteria conditions specific to each state or
tribal nation's definition. Users will be required to modify and review
the appropriate crosswalk tables for each step of the process. While
efforts have been made to reduce manual inputs, initial workflow may
require much additions and removals during each step.

There will be

**Additional Description:**

**...**

## Example with Data_WV_Mod1_Output

**Introduction:**

The goal is to assist states, territory and tribal nations with CWA
assessment and monitoring of waters against their WQS. The plan is to
focus on a high level summary of assessments. We will start with
capturing the magnitude component of criteria to determine impairment
decisions for a parameter and use. We will also incorporate the ability
to compare an org's standards with priority characteristics using EPA
304a standards.

Future functionalities will work to incorporate the Duration and
Frequency portion of criteria along with monitoring components
(comparing prior years assessments when possible) of WQS and other
functionalities such as with handling of equation based standards,
additional components such as low flow waters, comparing against other
state's standards when possible, capturing additional details of EPA
304a standards, and more.

**Creating the 3 Reference Tables**

We will work through an example of creating the three user reference
tables that will be needed in order to help users with defining the
criteria magnitude assessments for a parameter and use using the
Shepherdstown example.

Clean, harmonize and perform QAQC on the data frame for assessment.

```{r}
Data_NCTC <- Data_WV_Mod1_Output
```

Filter data frame by TADA.CharacteristicName(s) for a few priority
characteristics. Do some exploratory data analysis to view the number of
counts of TADA.ComparableDataIdentifier. Users can reference the domain
values of parameter names listed as a cause in prior assessment cycles
with the rATTAINS library function: domain_values.

```{r}
TADA_FieldValuesTable(Data_NCTC, field = "TADA.ComparableDataIdentifier")

rATTAINS::domain_values(domain_name = "ParameterName")
```

To begin the ATTAINS assessment process, you will create a blank
template of ATTAINS.ParameterName which needs crosswalk to a
TADA.ComparableDataIdentifier. Users should specify the name(s) of their
orgs that will be used for assessment.

By specifying the name of the ATTAINS organization(s) used, if creating
an excel spreadsheet (using excel = TRUE), this will create a separate
tab in the excel file which contains the parameter names used in prior
assessment cycles filtered by those ATTAINS organization(s). This will
allow users to decide whether to continue to use the same ATTAINS
parameter names from prior assessments that their org(s) have used in
the past, or to use other valid parameter names found in the ATTAINS
domain list. If there are no ATTAINS parameter name that properly
captures the TADA.ComparableDataIdentifier, users should consider
contacting the ATTAINS team first before proceeding.

```{r}
NCTC_ParamRef <- TADA_CreateParamRef(
  Data_NCTC,
  org_names = c("Maryland"),
  excel = FALSE # comment out this line 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
```

Users who have already completed this crosswalk can re-use this
reference file in the future. In this example, we will fill out the
excel blank template, read it into the R environment, and reuse this
parameter reference data frame that we have named "ParamRef".

If a user modifies this reference table directly in the R environment
only and not in the excel file, the user will need to re-run the
function using the "ParamRef" file to reflect the flagging of parameter
names.

```{r}
# only run the code chunks below if you make edits to the excel file.
# downloads_path <- file.path(Sys.getenv("USERPROFILE"), "Downloads", "myfileRef.xlsx")
# ParamRef <- openxlsx::read.xlsx(downloads_path, sheet = "CreateParamRef")

# NCTC_ParamRef3 <- TADA_CreateParamRef(
#   Data_NCTC,
#   org_names = c("Maryland"),
#   paramRef = ParamRef,
#   excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
#   #excel = TRUE, overwrite = TRUE
#   )

ParamRef <- dplyr::mutate(NCTC_ParamRef, ATTAINS.ParameterName = dplyr::case_when(
TADA.CharacteristicName == "PH" ~ "PH",
TADA.CharacteristicName == "ZINC" ~ "ZINC",
grepl("NITRATE", TADA.ComparableDataIdentifier) ~ "NITROGEN, TOTAL"
))

NCTC_ParamRef2 <- TADA_CreateParamRef(
  Data_NCTC,
  org_names = c("Maryland"),
  paramRef = ParamRef,
  excel = FALSE
) # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
# excel = TRUE, overwrite = TRUE)
```

Users may also include states outside of their spatial region if
desired, depending on a user's interest. Users will be responsible for
filling out this crosswalk for org(s)/state(s) that are outside their
own org(s). Although, future efforts will focus on creating a repository
of criteria and methods along with crosswalks done from other TADA
users.

```{r}
NCTC_ParamRef3 <- TADA_CreateParamRef(
  Data_NCTC,
  org_names = c("Maryland", "Florida"),
  paramRef = ParamRef,
  excel = FALSE
)
```

# Three cases of TADA_CreateParamUseRef().

First example will pull in all prior use_names for each ATTAINS
parameter name specific to the defined org_names argument input
"Maryland". Users will review this list and choose which use_name are
appropriate to define for assessment. The default is "Include" under the
"IncludeOrExclude" column. All use_names that will need a definition for
magnitude criteria and methodology should be labeled as "Include". If a
use_name is not appropriate, users should choose "Exclude" for that
ATTAINS parameter name and use name.

For any ATTAINS parameter name(s) that have not been used by this org in
prior assessment cycles, there will be no prior use names associated
with them. In this case, users will be responsible for inputting
additional rows as needed and choosing the appropriate use_name
applicable to their org under the column 'use_name'. In this example, we
can see "PH" was not a prior ATTAINS parameter name for Maryland, thus
additional rows should be inputted to reflect what parameter and use
combinations are needed to be defined for assessments (disclaimer: this
is for demonstration purposes only and does not reflect Maryland's
Criteria and Methodologies for PH).

```{r}
NCTC_ParamUseRef <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_names = c("Maryland"),
  paramRef = ParamRef,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
```

User can include the EPA304a standards with the input "org_names", which
utilizes the CST.PollutantName column created in TADA_CreateParamRef().
If a user includes additional orgs besides "Maryland" and "EPA304a", see example NCTC_ParamUseRef2 below, it
will not generate rows for those parameter and use combinations for
those additional orgs ("Virginia", "Pennsylvania", "West Virginia") as only Maryland was defined in
TADA_CreateParamRef() for paramRef = ParamRef.

```{r}
NCTC_ParamUseRef2 <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_names = c("EPA304a", "Maryland", "Virginia", "Pennsylvania", "West Virginia"),
  paramRef = ParamRef,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)

# User should only run TADA_CreateParamUseRef() which contains the orgs of interest. If there are other orgs that are interested, this should have been defined in TADA_CreateParamRef() for the paramRef argument input in which users will need to be aware of the appropriate parameter name crosswalk (if users share their criteria and methods in the future, this could be more feasible)
NCTC_ParamUseRef3 <- TADA_CreateParamUseRef(
  Data_NCTC,
  org_names = c("EPA304a", "Maryland"),
  paramRef = NCTC_ParamRef2,
  excel = FALSE # comment out 'excel = FALSE' and uncomment excel = TRUE, overwrite = TRUE to run the excel file
  # excel = TRUE, overwrite = TRUE
)
```

In this example, Maryland has decided to use an ATTAINS.ParameterName "PH" as a crosswalk that was not used in prior ATTAINS assessment cycle which results in the use_name column returning a blank value. Maryland will need to specify the use_name(s) that they would like to associate with "PH". In excel, there will be a drop down list of org specific use_names that were used in prior ATTAINS assessments. If no excel file was generated, this is an example workflow of what a user can do to edit the table in the R environment.

```{r}
add_data <- data.frame("organization_name" = "Maryland" ,"ATTAINS.ParameterName" = rep("PH",3), "use_name" = c("Aquatic Life and Wildlife", "Water Contact Sports",
"Seasonal Migratory Fish Spawning and Nursery Subcategory"
))

# The output of this will not reflect changes to the ATTAINS.FlagUseName column. To do so, we need to re run TADA_CreateParamUseRef() with paramUseRef = ParamUseRef as an argument.
ParamUseRef <- NCTC_ParamUseRef3 %>%
  dplyr::left_join(add_data, by = c("organization_name", "ATTAINS.ParameterName"), keep = FALSE) %>% 
  dplyr::mutate(use_name = coalesce(use_name.x, use_name.y)) %>% 
  dplyr::select(-c(use_name.x, use_name.y))

# PH will now reflect the changes 
NCTC_ParamUseRef3.1 <- TADA_CreateParamUseRef(
  Data_NCTC,
  paramUseRef = ParamUseRef, # Edits were made to paramUseRef, updates flag column
  org_names = c("EPA304a", "Maryland"), 
  paramRef = NCTC_ParamRef2, 
  # excel = FALSE # comment out 'excel = FALSE' and uncomment 'excel = TRUE, overwrite = TRUE' to run the excel file
  excel = TRUE, overwrite = TRUE 
  ) 
```

Users must review the matching done with TADA_GetATTAINS of monitoring
sites to AU. Users may also provide their own AU monitoring sites match
as a reference table. For any new WQP monitoring sites found in the TADA
dataframe, users will need to determine the appropriate match. Users can also
choose to not provide any sort of ML to AU crosswalk if they are only interested
in a monitoring location site level analysis of assessments. 

If there are site-specific criteria that only applies to some monitoring
locations within an AU, whether it's an ecoregion, for a specific
parameter and use, or if there are separate criteria for "warm-waters"
versus "cold-waters" or "trout-based" versus other species based, this
should be defined here. Users can further customize specific exclusions
that pertains to their water quality assessments. Users will be
responsible for filling out this unique spatial criteria under "ApplyUniqueSpatialCriteria" column.

In this example below, no ML to AU crosswalk was provided. 
```{r}
NCTC_AUIDRef <- TADA_CreateAURef(Data_NCTC, excel = TRUE, overwrite = TRUE)
# NCTC_AUIDRef <- TADA_CreateAUIDRef(Data_NCTC, overwrite = TRUE)
```

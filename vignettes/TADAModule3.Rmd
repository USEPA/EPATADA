---
title: "TADA Module 3: Integration of Common Water Quality Standards (WQS) Criteria"
format: html
editor: visual
author: "TADA Team"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    fig_caption: yes
    fig_height: 8
    fig_width: 8
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{TADA Module 3: Integration of Common Water Quality Standards (WQS) Criteria}
  %\VignetteEngine{knitr::rmarkdown}
description: An overview of TADA Module 3 functions and a recommended workflow.
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```

## Welcome!

Thank you for your interest in Tools for Automated Data Analysis (TADA).
TADA is an open-source tool set built in the R programming language.
This [RMarkdown](https://bookdown.org/yihui/rmarkdown/) document walks
users through how to download the TADA R package from GitHub, access and
parameterize several important functions, and create basic
visualizations with a sample data set.

**Note: TADA is still under development. New functionality is added
weekly, and sometimes we need to make bug fixes in response to tester
and user feedback. We appreciate your feedback, patience, and interest
in these helpful tools.**

**If you are interested in contributing to TADA development, more
information is available at:**

[**Contributing**](https://usepa.github.io/EPATADA/articles/CONTRIBUTING.html)

**We welcome collaboration with external partners.**

## Install and load packages

First, install and load the remotes package specifying the repo. This is
needed before installing TADA because it is only available on GitHub.

```{r install_remotes, results = 'hide', eval = F}
install.packages("remotes",
  repos = "http://cran.us.r-project.org"
)
library(remotes)
```

Next, install and load TADA using the remotes package. TADA R Package
dependencies will also be downloaded automatically from CRAN with the
TADA install. You may be prompted in the console to update dependency
packages that have more recent versions available. If you see this
prompt, it is recommended to update all of them (enter 1 into the
console).

```{r install_TADA, eval = F, results = 'hide'}
remotes::install_github("USEPA/EPATADA",
  ref = "develop",
  dependencies = TRUE
)
```

Finally, use the **library()** function to load the TADA R Package into
your R session.

```{r library, results = 'hide'}
library(EPATADA)
```

## Help pages

All TADA R package functions have their own individual help pages,
listed on the [Function
reference](https://usepa.github.io/EPATADA/reference/index.html) page on
the GitHub site. Users can also access the help page for a given
function in R or RStudio using the following format (example below):
`?[name of TADA function]`

```{r help_pages, eval = F}
# Access help page for TADA_DataRetrieval
?TADA_DataRetrieval
```

## WQS Criteria Functions in TADA

Disclaimer: ...

Use of Module 3 development and tools in the EPATADA package is to
assist different organization (state, territories and tribal nations) on
their assessment methods under the CWA. It does not constitute current
Agency policy or regulation requirements. This tool is not to be solely
used for decision making process. Module 3 integration of WQS for
assessments is not a regulation and does not impose legally binding
requirements on EPA or the States in reporting water conditions under
biannual reports of the CWA.

Criteria is defined as the standards (Magnitude), duration and frequency
associated with a parameter and designated use.

-   Standards (Magnitude) is defined as the limiting concentration not
    to be exceeded.

-   Duration is the period/length of time in which observations are
    aggregated.

-   Frequency is defined as the percent or number of times in which a
    magnitude can be exceeded during a time frame.

This vignette represents functions that provide users the option to:

-   Define the geospatial components, perform a parameter crosswalk
    between ATTAINS parameter names and WQP/TADA parameter names, and
    define the parameter and designated use of a water body associated
    with each state and participating tribe's WQS criteria.

-   Determine recommended impairment decisions for each parameter and
    designated use of a water body based on these defined WQS criteria
    conditions.

-   Compare and capture common methodologies on a state, territory and
    tribal nations criteria to protect designated uses in their WQS.

The EPA has derived its "national recommended Clean Water Act (CWA)
304(a) criteria". However, these standards do not account for regional
or site-specific conditions in which each state may derive its own
criteria. The functions in Module 3 TADA aims to be flexible to capture
these criteria conditions specific to each state or tribal nation's
definition. Users will be required to modify and review the appropriate
crosswalk for each step of the process. While efforts have been made to
reduce manual inputs, initial workflow may require much additions and
removals during each step.

**Additional Description:**

**...**

## 

This function requires users to have already ran TADA_GetATTAINS()
function (see TADAModule2.Rmd for more information on geospatial
functions).

Users will be required to first provide a crosswalk between the
Assessment Unit Identifier(s) (AUID) of interest and the corresponding
Monitoring Location Name/Identifier/TypeName(s) found within each AU.
Users will have the option to filter this dataframe AUID ref file by a
vector of AUID(s) or for all AUID found within the user's submitted TADA
dataframe pull.

First, we will need to pull in some TADA Water Quality Portal Data:

```{r}
# Nutrient data in Larimer county, CO for the year 2020.
TADA_dataframe <- TADA_DataRetrieval(
  startDate = "2020-01-01",
  endDate = "2020-12-31",
  characteristicType = "Nutrient",
  countycode = "US:08:069",
  applyautoclean = TRUE
)

TADA_dataframe2 <- TADA_FindQCActivities(TADA_dataframe, clean = FALSE)
TADA_dataframe3 <- TADA_FlagContinuousData(TADA_dataframe2)
#TADA_dataframe4 <- TADA_PairForCriteriaCalc(TADA_dataframe3)
TADA_dataframe4 <- TADA_FindPotentialDuplicatesSingleOrg(TADA_dataframe3)
TADA_dataframe5 <- TADA_RunKeyFlagFunctions(TADA_dataframe4)
TADA_dataframe6 <- TADA_HarmonizeSynonyms(TADA_dataframe5)
##################################################################
Co_dataframe <- TADA_DataRetrieval(
  statecode = "CO",
  startDate = "2020-01-01",
  endDate = "2020-12-31",
  characteristicName  = c("Zinc","Nitrate", "pH"),
  countycode = "US:08:069",
  applyautoclean = TRUE
)

Co_dataframe2 <- TADA_FindQCActivities(Co_dataframe, clean = FALSE)
Co_dataframe3 <- TADA_FlagContinuousData(Co_dataframe2)
#TADA_dataframe4 <- TADA_PairForCriteriaCalc(TADA_dataframe3)
Co_dataframe4 <- TADA_FindPotentialDuplicatesSingleOrg(Co_dataframe3)
Co_dataframe5 <- TADA_RunKeyFlagFunctions(Co_dataframe4)
Co_dataframe6 <- TADA_HarmonizeSynonyms(Co_dataframe5)

Co_dataframe7_ATTAINS <- TADA_GetATTAINS(Co_dataframe6)

Co_dataframe7_ATTAINS2 <- as.data.frame(Co_dataframe7_ATTAINS$TADA_with_ATTAINS)
unique(Co_dataframe7_ATTAINS2$OrganizationFormalName)
unique(Co_dataframe7_ATTAINS2$ATTAINS.organizationname)
unique(Co_dataframe7_ATTAINS2$OrganizationIdentifier)
TADA_FieldValuesTable(Co_dataframe_ATTAINS2, field = "OrganizationIdentifier")

# Handling of replicate samples with differing resultmeasurevalue when they are not labeled as a duplicate.
# TADA_dataframe5 <- TADA_dataframe4 %>%
#   dplyr::select(TADA.CharacteristicName,TADA.ResultSampleFractionText,TADA.MethodSpeciationName, 
#                 ActivityStartDateTime, ActivityIdentifier, MonitoringLocationIdentifier, 
#                 TADA.ResultMeasureValue, TADA.ResultMeasure.MeasureUnitCode, 
#                 setdiff(colnames(TADA_dataframe4), colnames(TADA_dataframe))
#                 ) %>%
#   dplyr::filter(TADA.SingleOrgDup.Flag == "Unique") %>%
#   dplyr::filter()
```

## `TADA_CreateAUIDRef()`

Now, `TADA_GetATTAINS()` returns a dataframe containing the original
TADA WQP dataset, plus new columns representing the ATTAINS assessment
unit(s) that fall within the same NHDPlus HR catchment as them. This
means that it is possible for a single TADA WQP observation to have
multiple ATTAINS assessment units linked to it and subsequently more
than one row of data. Such WQP observations can be identified using the
new `index` column (i.e., multiple rows with the same index value are
the same observation).

```{r}
TADA_with_ATTAINS <- TADA_GetATTAINS(TADA_dataframe6, return_sf = TRUE)
```

## `TADA_CreateParamRef()`

This function will require users to provide a crosswalk between ATTAINS
parameters and TADA parameters. Users will need to define this crosswalk
for each parameter and will give users the flexibility to perform this
crosswalk in an excel spreadsheet or in the R environment. The excel
spreadsheet allows users to view drop-down list of prior parameter names
that were used in previous ATTAINS cycles.

```{r}
temp <- as.data.frame(TADA_with_ATTAINS$TADA_with_ATTAINS)

# Users must define the appropriate crosswalk map between ATTAINS parameter and WQP parameters. This creates a blank template.
Co_ParamRef <- TADA_CreateParamRef(temp, overwrite = TRUE)
```

User should open this file and, in the "CreateParamRef" tab, make the
appropriate parameter crosswalk between ATTAINS Parameters and TADA
Parameters. A dropdown of allowable values in an excel spreadsheet for
each column is created. All unique combinations of TADA Characteristic
Name, TADA Speciation, and TADA Fraction are created from the TADA data
frame provided, and col B for ATTAINS.CharacteristicName should be the
only modified column (should we freeze/protect other columns?)

The path of the file is automatically saved to the user's Downloads
folder. If there are issues with the download path, users will need to
specify their desired locations path as an argument in
TADA_CreateParamRef().

```{r}
# Users can choose to save TADA_ParamRef as an R dataframe if they desire or edit directly in excel and save the file while proceeding to use excel = TRUE as an argument.
downloads_path <- file.path(Sys.getenv("USERPROFILE"), "Downloads", "myfileRef.xlsx")

# This opens the excel .xlsx file and returns the [CreateParamRef] tab that contains the crosswalk.
ParamRef <- openxlsx::read.xlsx(downloads_path, sheet = "CreateParamRef")
```

User can now save this completed ParamRef file for future uses as an
argument input

```{r}
# User can now save this reference file to be used as an input in future assessments. User must include overwrite = TRUE if they would like to overwrite the excel [CreateParamRef] tab. This input is included to avoid overwriting a user's crosswalking input efforts if they accidentally run TADA_CreateParamRef() again or forget to load it into the R environment.
Co_ParamRef2 <- TADA_CreateParamRef(temp, paramRef = ParamRef, excel = TRUE, overwrite = TRUE)

# If a user already has a completed paramRef file, this is an example of not creating an excel sheet but only load it into the R environment.
Co_ParamRef3 <- TADA_CreateParamRef(temp, paramRef = ParamRef, excel = FALSE)
```

If a user decides to do the parameter cross walk in the R environment,
they will need to ensure they run validate = TRUE as an argument input
after making any edits to the reference table. This is done to refresh
the flagging column appropriately.

```{r}
# User decides they want to use the 304a standards, and will input "EPA 304a" for each row value under the organization_name. 
Co_ParamRef4 <- dplyr::mutate(Co_ParamRef3, organization_name = "EPA 304a")
# Looking at the dataframe, we can see the ATTAINS.FlagParameterName still has the old values that does not reflect the changes that were made.
View(Co_ParamRef4)

# User will need to run validate = TRUE with the paramRef argument that contains this reference table update. User will now see th reflected changes for ATTAINS.FlagParameterName. 
Co_ParamRef5 <- TADA_CreateParamRef(.data = temp, paramRef = Co_ParamRef4, validate = TRUE, excel = FALSE)

Co_ParamRef5 <- TADA_CreateParamRef(.data = temp, paramRef = Co_ParamRef4, validate = TRUE, excel = TRUE, overwrite = TRUE)
```

```{r}
Co_ParamUseRef <- TADA_CreateParamUseRef(.data = temp, overwrite = TRUE, paramRef = Co_ParamRef3, excel = TRUE)
```

Now, create a new reference dataframe with ONLY the unique combinations
of WQP MonitoringLocationIdentifier's and ATTAINS Assessment Unit
Identifiers.

```{r}
TADA_AUIDRef <- TADA_CreateAUIDRef(.data = temp, overwrite = TRUE) 
```

Users will need to modify this AUID reference file to be compatible with
their submission to ATTAINS for the current Assessment cycle. If a new
AUID is needed, users should add an additional row to this reference
file with the appropriate latitude and longitude associated with it.
Users will have the option to include or exclude an AU from their WQS
assessments in the last column if a specific AU wants to be excluded
from calculation for a certain parameter, but may still be referenced in
the future if needed.

## `Example with Data_NCTCShepherdstown_HUC12`

```{r}
# Run TADA_GetATTAINS on example data frame
test <- TADA_GetATTAINS(Data_NCTCShepherdstown_HUC12)
Data_NCTC <- as.data.frame(test$TADA_with_ATTAINS)
unique(Data_NCTC$OrganizationFormalName)

# Filter data frame by TADA.Characteristics
Data_NCTC2 <- filter(Data_NCTC, TADA.CharacteristicName %in% c("ZINC","Nickel", "PH","TEMPERATURE","NITRATE"))

# Creates a blank template of ATTAINS.ParameterName which needs crosswalk
NCTC_ParamRef <- TADA_CreateParamRef(Data_NCTC2, excel = TRUE, overwrite = TRUE)

# Users who have already completed this crosswalk can re-use this reference file in the future.
downloads_path <- file.path(Sys.getenv("USERPROFILE"), "Downloads", "myfileRef.xlsx")
NCTC_ParamRef <- openxlsx::read.xlsx(downloads_path, sheet = "CreateParamRef")

NCTC_ParamRef2 <- TADA_CreateParamRef(
  Data_NCTC2,
  paramRef = NCTC_ParamRef, 
  excel = FALSE
  )

# Users should specify the name(s) of their orgs that will be used for assessment.
NCTC_ParamRef3 <- TADA_CreateParamRef(
  Data_NCTC2, 
  org_names = c("Maryland"),
  paramRef = NCTC_ParamRef, 
  excel = TRUE, overwrite = TRUE
  )

# Three cases of 
NCTC_ParamUseRef <- TADA_CreateParamUseRef(
  Data_NCTC2, 
  paramRef = NCTC_ParamRef, 
  excel = TRUE, 
  overwrite = TRUE
  )

NCTC_ParamUseRef2 <- TADA_CreateParamUseRef(
  Data_NCTC2, 
  org_names = c("EPA304a", "Maryland", "Virginia", "Pennsylvania", "West Virginia"), 
  paramRef = NCTC_ParamRef2, 
  excel = TRUE, overwrite = TRUE
  )

NCTC_ParamUseRef3 <- TADA_CreateParamUseRef(
  Data_NCTC2, 
  org_names = c("EPA304a", "Maryland"), 
  paramRef = NCTC_ParamRef3, 
  excel = TRUE, overwrite = TRUE
  )

NCTC_AUIDRef <- TADA_CreateAUIDRef(Data_NCTC2, overwrite = TRUE)

NCTC_DefineMagnitude <- TADA_DefineMagnitude(
  .data = Data_NCTC2, 
  paramRef = NCTC_ParamRef2,
  paramUseRef = NCTC_ParamUseRef3, 
  AUIDRef = NCTC_AUIDRef, 
  excel = TRUE,
  overwrite = TRUE
  )
```

Users can provide the ParamRef as a R data frame, or users can choose to
make the edits on the excel spredsheet file created in the downloads
folder, or other specified folder path location which can be defined as
an argument.

The AUIDRef file is a required argument. Users will need to have ran
this function and make any appropriate edits.

```{r}
TADA_StandardsRef <- TADA_CreateStandardsRef(TADA_dataframe, ParamRef = TADA_ParamRef, AUIDRef = TADA_AUIDRef, overwrite = TRUE)
```

```{r}
TADA_StandardsRef <- TADA_CreateStandardsRef(TADA_dataframe, ParamRef = TADA_ParamRef, AUIDRef = TADA_AUIDRef)

```

## `TADA_CreateAdditionalStandardsRef()`

Users will have the

```{r}

```

## `TADA_CreateDurationFreqRef()`

TADA Priority Ref Duration will be used as a default. For all other
parameters not found as a priority, users will have the option to
autofill them as either "NA" or "1 discrete observation" as an argument.
If left as NA, users will fill in the values on their own for their
organization's WQS requirement.

```{r}
```

## `TADA_CreateCriteriaRef()`

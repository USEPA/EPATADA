---
title: "Efficient and Reproducible Water Quality Analyses Using R"
header: "TADA, dataRetrieval, StreamCatTools, nhdplusTools, hydroloom"
format:  
  revealjs:
    theme: serif
editor: visual
editor_options: 
    wrap: 72
author:
  - name: "Cristina Mullin"
    orcid: 0000-0002-0615-6087
    email: mullin.cristina@epa.gov
    affiliation: 
      - name: Office of Water, Water Data Integration Branch, Environmental Protection Agency
        city: Washington, D.C., United States
        url: https://www.epa.gov/waterdata/TADA
footer: "EPATADA, dataRetrieval, nhdplusTools, StreamCatTools, hydroloom"
---

# Introduction

## Quarto

Quarto enables you to weave together content and executable code into a finished presentation. To learn more about Quarto presentations see <https://quarto.org/docs/presentations/>.

## Contributors

-   Cristina Mullin
-   Hillary Marler
-   Kenny Wong
-   Shelly Thawley
-   Dave Blodgett
-   Marc Weber
-   Ryan Hill
-   Michael Dumelle

## Intended audience

Water Quality Portal community, Clean Water Act Assessment community (EPA, States and Tribal Nations), R users, water quality analysts and researchers, geospatial data analysts, USGS and other federal agencies.

## Agenda

This hands-on workshop showcases how to integrate several R Packages developed by the U.S. Environmental Protection Agency (EPA) and the United States Geological Survey (USGS) and other fundamental packages to create efficient and reproducible workflows that support water quality programs and research – for example performing Clean Water Act Assessments, watershed analyses, and building statistical models.

## Agenda

It also incorporates secondary use of publicly available water quality data from the Water Quality Portal (WQP) and other web services and libraries for easy ingestion of additional hydrologic, climatic and remote sensing data.

## Agenda

To start, participants will learn how to use EPA’s Tools for Automated Data Analysis (TADA) R Package to retrieve, wrangle, harmonize, quality check, visualize and analyze WQP data. Then it will cover approaches for hydrology and watershed (e.g., Assessment Unit level) analysis and visualization – including use of the StreamCatTools, nhdplusTools and hydroloom R libraries, as well as fundamental geospatial packages such as sf, terra, leaflet and tmap.

## Packages

- EPA: EPATADA, StreamCatTools

- USGS: dataRetrieval, nhdplusTools, hydroloom

- Fundamentals: sf, terra, leaflet and tmap

# Preparing Water Quality Portal (WQP) data for analysis using EPATADA

## Retrieve

## Wrangle

## Harmonize

## Quality check

## Visualize

## Analyze

# Ingestion of additional hydrologic, climatic and remote sensing data

## Combine hydrologic, climatic and remote sensing data with WQP data

1.  USGS continuous sensor data
2.  PRISM climate

# Example Use Case 1: Clean Water Act (CWA) Section 303(d) Assessments

## CWA Assessment Process

We do not have time to cover the full process today. Let's focus on geospatial aspects!

[Integrated Reporting Memoranda under CWA Sections 303(d), 305(b) and 314](https://www.epa.gov/tmdl/Integrated%20Reporting%20Guidance%20under%20CWA%20Sections%20303%28d%29%2C%20305%28b%29%20and%20314).

## What are Assessment Units?

Geospatial areas for analysis. Let's assign data to those units!

CWA assessment determinations are made by assessment unit, meaning the entire assessment unit is assessed as either meeting or not meeting water quality standards (i.e., thresholds or criteria) for all designated uses.

## How are assessment units delineated?

Assessment units are typically delineated by using watershed-oriented collections of stream reaches, often broken down by physical features like waterfalls, bridge crossings, or changes in land use, to analyze water quality impairments within a specific area, ensuring data homogeneity and spatial clarity within the assessment unit.

-   Existing Assessment Units are available from ATTAINS geospatial services

## Associating ATTAINS Assessment Units with WQP Monitoring Locations

One of the first steps in the CWA assessment process is to define Assessment Units and associate data with them. A major source for water quality data is the WQP.

## Associating ATTAINS Assessment Units with WQP Monitoring Locations

-   Assessment Units: state or tribal waterbody geospatial features
    -   These may be lines, areas or points
-   Water Quality Portal Monitoring Locations
    -   points

## TADA_GetATTAINS()

-   Automated matching of WQP monitoring locations with ATTAINS assessment units that fall within (intersect) the same NHDPlus catchment ([details](https://usepa.github.io/EPATADA/articles/TADAModule2.html))
-   The function uses high resolution NHDPlus catchments by default because 80% of state submitted assessment units in ATTAINS were developed based on high res NHD; users can select med-res if applicable to their use case

## Challenges with Automated Approach

-   Certain NHDPlus high res catchments overlap multiple ATTAINS assessment units (state submitted hydrography) which means the sites are assigned to both AUs in the current functions. Another challenge is that the WQP sites are not always accurate (imprecise coordinates). Ideally, each site could be matched with a single assessment unit and not multiple.

## Challenges with Automated Approach
-   Placeholder: Are there tools to help with these challenges (i.e., QAQC'ing draft TADA site/AU associations)?
    -   Can more sophisticated logic (e.g., maybe flow/rain drop logic or even simply closest AU) be added for areas where multiple assessment units overlap the same high-res catchment (for example at tributaries)?

## Challenges with Automated Approach

-   Use EPA WATERS or nhdplusTools?
    -   Note: WQP location metadata may also be helpful for matching/QAQC'ing waterbody names with ATTAINS waterbody names instead of relying solely on the lat/long and geospatial/mapping information.

## Using all available data

Finally, some waterbodies have data available in the WQP or from other sources, but there are no existing Assessment Units in ATTAINS for them. In the next section, we will share a way to create create AU's using NHDPlus high resolution catchments.

## Creating new AUs to assess additional areas

TADA has included a way to do this using TADA_GetATTAINS() fill_catchments function input. This is included for exploratory purposes only. In theory the high res catchments could be created as new assessment unit polygons, but that process is outside of TADA.

## Creating new AUs to assess additional areas with TADA::fetchNHD()

For WQP monitoring sites that DO NOT overlap an existing ATTAINS feature (neither ATTAINS NHDPlus high res catchment snap shot or state submitted points/lines/polys), there is nothing to use from ATTAINS because these are areas where there is WQP data but no ATTAINS AU yet. 

## Creating new AUs to assess additional areas with TADA::fetchNHD()

For these, we implemented a solution using NHDPlusTools to pull in either NHDPlus high res or med res catchments (user can choose, but high res is the default) and match those with the WQP sites & create new IDs (essentially creating new AUs that are the catchments that intersect these WQP sites).

## Creating new AUs to assess additional areas with TADA::fetchNHD()

-   Do we want to include anything else from StreamCatTools or other packages here to help with new AU delineation?


    
# Example Use Case 2: Building Statistical Models

placeholder
